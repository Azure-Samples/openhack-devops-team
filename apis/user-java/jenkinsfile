pipeline {
    agent any

    tools {
        maven '3.5.4'
    }

    environment {
        APP_NAME = 'devopsoh/api-user-java'
        SRC_DIR = 'apis/user-java'
        IMG_TAG = "${env.BUILD_TAG}"
    }

    stages{  
        stage('Execute Tests and publish test and code coverage report') {
            steps {
                dir("${env.SRC_DIR}") {
                    sh '''
                        echo "Initiating test phase."
                        mvn clean test
                    '''
                }
            }
            post {
                always {
                    junit "**/target/surefire-reports/*.xml"
                    jacoco()
                }
            }
        }

         stage('Verify code coverage meets threshold') {
            steps {
                dir("${env.SRC_DIR}") {
                    sh '''
                        echo "Verify code coverage"
                        mvn verify
                    '''
                }
            }
        }
        
    }
}